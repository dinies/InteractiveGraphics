<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
        <meta charset="utf-8"/>
    </head>
    <script id="vertex-shader" type="x-shader/x-vertex">
     precision mediump float;
     attribute  vec4 vPosition;
     attribute  vec4 vColor;
     varying vec4 fColor;
     varying vec3 pos_for_frag;
     varying vec3 N_for_frag;
     attribute vec3 vNormal;
     vec4 ambient, diffuse, specular;
     uniform vec4 spotlightAmbientProduct;
     uniform vec4 spotlightSpecularProduct;
     uniform vec4 spotlightDiffuseProduct;
     uniform vec4 spotlightLightPosition;
     uniform vec3 spotlight_coneDirection;
     uniform float spotlight_thetaCone;
     uniform float spotlight_cutOff;
     uniform float shininess;
     uniform float constant_attenuation;
     uniform float linear_attenuation;
     uniform float quadratic_attenuation;
     uniform mat4 projectionMatrix;
     uniform mat4 viewMatrix;
     uniform mat4 modelMatrix;
     uniform mat3 normalMatrix;
     void main()
     {
         //pos is the vector from the eye towards the vertex (counter-intuitive)
         //vec3 pos = -(modelViewMatrix * vPosition).xyz;
         // vec4 NN = vec4(vNormal,0);
         // N_for_frag = normalize((modelViewMatrix * NN).xyz);

         N_for_frag = normalize( normalMatrix * vNormal );
         pos_for_frag= vec3(  (modelMatrix * vPosition).xyz );
         fColor= vColor;

         gl_Position = projectionMatrix * viewMatrix * modelMatrix * vPosition;

         //gl_Position.z = -gl_Position.z;  greveeee
     }
    </script>
    <script id="fragment-shader" type="x-shader/x-fragment">
     precision mediump float;
     varying vec4 fColor;
     uniform bool flagSpotlightLight;
     uniform vec4 spotlightAmbientProduct;
     uniform vec4 spotlightSpecularProduct;
     uniform vec4 spotlightDiffuseProduct;
     uniform vec4 spotlightLightPosition;
     uniform vec3 spotlight_coneDirection;
     uniform float spotlight_thetaCone;
     uniform float spotlight_cutOff;
     uniform float shininess;
     uniform float constant_attenuation;
     uniform float linear_attenuation;
     uniform float quadratic_attenuation;
     varying vec3 pos_for_frag;
     varying vec3 N_for_frag;
     void
     main()
     {
         vec3 N = normalize( N_for_frag);
         vec3 E_for_frag =  normalize(-pos_for_frag);
         vec3 spotlightLight = spotlightLightPosition.xyz;
         vec3 L_spotlight_for_frag= normalize( spotlightLight - pos_for_frag);
         float spotlight_intensity_multiplier;
         vec3 C= normalize(spotlight_coneDirection);
         //s= vector from the spotlight source towards the surface
         vec3 s= -L_spotlight_for_frag;
         //check if the cone direction and the direction towards the surface point are concordant
         //check if the overall direction is concorde, otherwise the light cone will be pointed in the other direction w.t.r. the surface.
         // if( dot(s,C) <= 0.0){
         //     spotlight_intensity_multiplier = 0.0;
         // }
         // else{
         float phi_angle= acos(dot(s,C));
         // check if the surface point is outside the cone of projected light
         // if(degrees(phi_angle) > spotlight_thetaCone){
         //     spotlight_intensity_multiplier = 0.0;
         // }
         // else{
         spotlight_intensity_multiplier= pow(cos(phi_angle), spotlight_cutOff);
         // }
         // }
         vec3 H_spotlight = normalize(L_spotlight_for_frag + E_for_frag);
         vec4 spotlight_ambient = spotlightAmbientProduct;
         float Kd3_l = max(dot(L_spotlight_for_frag, N),0.0);// THERE
         float Kd3_r = max(dot(L_spotlight_for_frag, -N),0.0);// THERE
         float Kd3 = Kd3_l + Kd3_r;
         vec4  spotlight_diffuse = Kd3 * spotlightDiffuseProduct;
         float Ks3 = pow(max(dot(N, H_spotlight), 0.0), shininess);
         vec4  spotlight_specular = Ks3 * spotlightSpecularProduct;
         // if (dot(L_spotlight_for_frag, N) < 0.0) {
         //     spotlight_specular = vec4(0.0, 0.0, 0.0, 1.0);
         // }
         vec3 dist_spotlight=(spotlightLight - pos_for_frag);
         float dist_norm_spotlight = sqrt(pow(dist_spotlight.x , 2.0) + pow(dist_spotlight.y, 2.0) + pow(dist_spotlight.z, 2.0));
         float attenuation_spotlight= 1.0/ ( constant_attenuation + (linear_attenuation* dist_norm_spotlight) + (quadratic_attenuation* pow(dist_norm_spotlight, 2.0)) );
         vec4 spotlightColor = spotlight_ambient + (spotlight_intensity_multiplier * attenuation_spotlight *(spotlight_diffuse + spotlight_specular));
         vec4 finalColor= vec4(0.0,0.0,0.0,1.0);
         finalColor= finalColor + spotlightColor;
         finalColor.a=1.0;
         gl_FragColor = (finalColor * fColor) ;
     }
    </script>
    <script type="text/javascript" src="../Common/webgl-utils.js"></script>
    <script type="text/javascript" src="../Common/initShaders.js"></script>
    <script type="text/javascript" src="../Common/MV.js"></script>
    <script type="text/javascript" src="../Common/math.js"></script>
    <script type="text/javascript" src="figures.js"></script>
    <script type="text/javascript" src="world.js"></script>
    <body>
        <canvas id="gl-canvas" width="512" height="512">
            Oops ... your browser doesn't support the HTML5 canvas element
        </canvas>
    </body>
</html>
